---
title: "ISSPxVTS_v5 analysis"
author: "Yu-Chin Chiu"
date: "June 11, 2018"
output: github_document
---


```{r knitSetup}
knitr::opts_chunk$set(fig.width=6, fig.height=4, fig.path='figure/', echo = FALSE, warning = FALSE, message = FALSE)
options(width = 9999)

```

#### First, Set up the environment and load the data: gpData.csv 
This file came from python scripts - cleaning and preprocessing

```{r setup}
rm(list=ls())
library('tidyverse')
library('ez')
library('BayesFactor')
library('apaTables')

currentDir <- getwd()
gpData = read_csv('gpData.csv',col_names=TRUE)
source("getWSSE.R")

```


#### Set up some formating for the plots
Set up some good format, here I am using apatheme with white background, with black axis lines, no grids.

```{r fig apa-format}
apatheme = theme_bw()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line=element_line())
dodge = position_dodge(width=0.9)


```


```{r analysis_prep}
# create a new variable called "run_half": run3,4 = B1, run5-6 = B2, run7-8 = B3

gpData[which(gpData$phase=="hybrid" & gpData$runId==3), "runId_half"]="B1"
gpData[which(gpData$phase=="hybrid" & gpData$runId==4), "runId_half"]="B1"
gpData[which(gpData$phase=="hybrid" & gpData$runId==5), "runId_half"]="B2"
gpData[which(gpData$phase=="hybrid" & gpData$runId==6), "runId_half"]="B2"
gpData[which(gpData$phase=="hybrid" & gpData$runId>=7), "runId_half"]="B3"

# mark trials with ACC=0, RT=NA, only analyze CORRECT TRIALS' RT
gpData[which(gpData$sbjACC==0), "sbjRT"]=NA

# Turn a bunch of codings into categorical factors
catVblList <- c("phase","sbjId","runId", "swProb", "task", "trialType_sw", "runId_half")
idx <- match(catVblList, colnames(gpData))
for (c in idx[!is.na(idx)]){
  gpData[[c]] <- factor(gpData[[c]], ordered = TRUE)
}

gpData$phase <- factor(gpData$phase, levels = c("training", "hybrid"), ordered=TRUE)
gpData$trialType <- factor(gpData$trialType, levels = c("cued", "choice"), ordered=TRUE)
gpData$trialType_sw <- factor(gpData$trialType_sw, levels = c("switch", "repeat"), ordered=TRUE)


NrS <- length(unique(gpData$sbjId))
NrS

```

```{r}
# exclude subjects with low task-switching accuracy and very low VSR
mean_tsACC_cuedTrials <- gpData %>% 
  filter(trialType=="cued") %>%
  group_by(sbjId) %>%
  summarise(tsACC = mean(sbjACC, na.rm = TRUE))

mean_tsACC_training <- gpData %>% 
  filter(phase=="training") %>%
  group_by(sbjId) %>%
  summarise(tsACC = mean(sbjACC, na.rm = TRUE))

mean_VSR <- gpData %>% 
  filter(phase=="hybrid" & trialType=="choice") %>%
  group_by(sbjId) %>%
  summarise(VSR = mean(trialType_int, na.rm = TRUE))  

valid_sbjList <- c(NULL)
cnt=0
for (i in 1:nrow(mean_VSR)){
  if (mean_tsACC_cuedTrials$tsACC[i] < .80 | mean_VSR$VSR[i] < .10) {
  }
  else{
    cnt=cnt+1
    valid_sbjList[cnt]<- mean_tsACC_training$sbjId[i]
  }
}

NrS_valid <- length(valid_sbjList)

NrS_valid

gpData_raw <-gpData
gpData<- tibble()
gpData <- gpData_raw[gpData_raw$sbjId %in% valid_sbjList, ] 

```
## RESULTS: 
### 1. Cued trials
#### Analyze with 2 phase x 2 swProb x trialType_sw 
```{r}
gpCondM1 <- tibble()
gpCondM1 <- gpData %>% 
  filter(trialType=="cued") %>%
  group_by(sbjId, phase, swProb, trialType_sw) %>%
  summarise(meanRT = mean(sbjRT, na.rm = TRUE), meanACC = mean(sbjACC, na.rm = TRUE)) %>%  ungroup() 

df <- gpCondM1 %>% select(-meanACC)
colnames(df)[colnames(df)=="meanRT"] <- "M"
LnMSE_rt <- getWSSE(df)

df <- gpCondM1 %>% select(-meanRT)
colnames(df)[colnames(df)=="meanACC"] <- "M"
LnMSE_acc <- getWSSE(df)

ISSP <- gpCondM1 %>%
  group_by(phase, swProb, trialType_sw) %>% 
  summarise(gpmeanRT = mean(meanRT), SE_rt = LnMSE_rt , gpmeanACC = mean(meanACC)*100, SE_acc = LnMSE_acc*100) 

```
#### Figure 1: RT
```{r Figure1}
ISSP %>%
  ggplot(aes(x=swProb, y = gpmeanRT, fill = trialType_sw)) + 
  geom_col(position = dodge) + 
  geom_errorbar(aes(ymax = gpmeanRT + (1*SE_rt), ymin =gpmeanRT -(1*SE_rt)), position = dodge, width=.25) + facet_grid(.~phase) + 
  ylab("mean RT (correct trials)") + 
  coord_cartesian(ylim = c(600,900)) +
  scale_fill_grey()

#### 3-way ANOVA: cued trials: RT ~ 2 phase x 2 swProb x 2 trialType_sw

z = ezANOVA(data = gpCondM1
            , dv = meanRT
            , wid = sbjId
            , within = .(phase, swProb, trialType_sw)
            , within_full = .(phase, swProb, trialType_sw)
            , type = 3
            , detailed = TRUE)
z_table <- apa.ezANOVA.table(z, filename="RT_2phasex2swProbx2trialTypeSw.doc")
print(z_table)

```
#### Figure 2: Acc
```{r Figure2}
ISSP %>%
  ggplot(aes(x=swProb, y = gpmeanACC, fill = trialType_sw)) + 
  geom_col(position = dodge) + 
  geom_errorbar(aes(ymax = gpmeanACC + (1*SE_acc), ymin =gpmeanACC -(1*SE_acc)), position = dodge, width=.25) + facet_grid(.~phase) + 
  ylab("mean ACC") + 
  coord_cartesian(ylim = c(80,100)) +
  scale_fill_grey()

#### 3-way ANOVA: cued trials: ACC ~ 2 phase x 2 swProb x 2 trialType_sw

z = ezANOVA(data = gpCondM1
            , dv = meanACC
            , wid = sbjId
            , within = .(phase, swProb, trialType_sw)
            , within_full = .(phase, swProb, trialType_sw)
            , type = 3
            , detailed = TRUE)

z_table <- apa.ezANOVA.table(z, filename="ACC_2phasex2swProbx2trialTypeSw.doc")
print(z_table)
```

### 2. Choice trials
#### Analyze with RT/ACC with 2 swProb x 2 trialType_sw 
```{r}
gpCondM2 <- tibble()
gpCondM2 <- gpData %>% 
  filter(trialType=="choice") %>%
  filter(trialType_sw=="switch" | trialType_sw=="repeat") %>%
  group_by(sbjId, swProb, trialType_sw) %>%
  summarise(meanRT = mean(sbjRT, na.rm = TRUE), meanACC = mean(sbjACC, na.rm = TRUE)) %>% ungroup() 


df <- gpCondM2 %>% select(-meanACC)
colnames(df)[colnames(df)=="meanRT"] <- "M"
LnMSE_rt <- getWSSE(df)

df <- gpCondM2 %>% select(-meanRT)
colnames(df)[colnames(df)=="meanACC"] <- "M"
LnMSE_acc <- getWSSE(df)

ISSP_choice <- gpCondM2 %>%
  group_by(swProb, trialType_sw) %>% 
  summarise(gpmeanRT = mean(meanRT), SE_rt = LnMSE_rt , gpmeanACC = mean(meanACC)*100, SE_acc = LnMSE_acc*100) 
```
#### Figure 3: RT
```{r Figure3}
ISSP_choice %>%
  ggplot(aes(x=swProb, y = gpmeanRT, fill = trialType_sw)) + 
  geom_col(position = dodge) + 
  geom_errorbar(aes(ymax = gpmeanRT + (1*SE_rt), ymin =gpmeanRT -(1*SE_rt)), position = dodge, width=.25)+ 
  ylab("mean RT (correct trials)") + 
  coord_cartesian(ylim = c(600,900)) +
  scale_fill_grey()

#### 2-way ANOVA: choice trials: RT ~ 2 swProb x 2 trialType_sw

z = ezANOVA(data = gpCondM2
            , dv = meanRT
            , wid = sbjId
            , within = .(swProb, trialType_sw)
            , within_full = .(swProb, trialType_sw)
            , type = 3
            , detailed = TRUE)

z_table <- apa.ezANOVA.table(z, filename="Choice_RT_2swProbx2trialTypeSw.doc")
print(z_table)
```
#### Figure 4: ACC
```{r Figure4}
ISSP_choice %>%
  ggplot(aes(x=swProb, y = gpmeanACC, fill = trialType_sw)) + 
  geom_col(position = dodge) + 
  geom_errorbar(aes(ymax = gpmeanACC + (1*SE_acc), ymin =gpmeanACC -(1*SE_acc)), position = dodge, width=.25) + 
  ylab("mean ACC") + 
  coord_cartesian(ylim = c(85,100)) +
  scale_fill_grey()

#### 2-way ANOVA: choice trials: ACC ~ 2 swProb x 2 trialType_sw

z = ezANOVA(data = gpCondM2
            , dv = meanACC
            , wid = sbjId
            , within = .(swProb, trialType_sw)
            , within_full = .(swProb, trialType_sw)
            , type = 3
            , detailed = TRUE)
z_table <- apa.ezANOVA.table(z, filename="Choice_ACC_2swProbx2trialTypeSw.doc")
print(z_table)

```

### 3. Choice trials
#### Analyze VSR and tskRatio with 2 swProb 
```{r}

gpCondM3 <- tibble()
gpCondM3 <- gpData %>% 
  filter(trialType=="choice") %>%
  filter(trialType_sw=="switch" | trialType_sw=="repeat") %>%
  group_by(sbjId, swProb) %>%
  summarise(meanVSR = mean(trialType_int, na.rm = TRUE), meanTskRatio = mean(task_int, na.rm = TRUE)) %>% ungroup() 

df <- gpCondM3 %>% select(-meanTskRatio)
colnames(df)[colnames(df)=="meanVSR"] <- "M"
LnMSE_VSR <- getWSSE(df)

df <- gpCondM3 %>% select(-meanVSR)
colnames(df)[colnames(df)=="meanTskRatio"] <- "M"
LnMSE_tskR <- getWSSE(df)

# summary for plotting later on
gp_choice <- gpCondM3 %>%
  group_by(swProb) %>% 
  summarise(gpmeanVSR = mean(meanVSR)*100, SE_vsr = LnMSE_VSR*100 , gpmeanTskRatio = mean(meanTskRatio)*100, SE_tskR = LnMSE_tskR*100) 

```
#### Figure 5: VSR
```{r Figure5}
gp_choice %>%
  ggplot(aes(x=swProb, y = gpmeanVSR)) + 
  geom_col(position = dodge) + 
  geom_errorbar(aes(ymax = gpmeanVSR + (1*SE_vsr), ymin =gpmeanVSR -(1*SE_vsr)), position = dodge, width=.25) + 
  ylab("mean VSR") + 
  coord_cartesian(ylim = c(30,40)) +
  scale_fill_grey()

#### 1-way ANOVA: choice trials: VSR ~ 2 swProb 
z = ezANOVA(data = gpCondM3
            , dv = meanVSR
            , wid = sbjId
            , within = .(swProb)
            , within_full = .(swProb)
            , type = 3
            , detailed = TRUE)
z_table <- apa.ezANOVA.table(z, filename="VSR_2swProb.doc")
print(z_table)

```
#### Figure 6: taskBias
```{r Figure6}
gp_choice %>%
  ggplot(aes(x=swProb, y = gpmeanTskRatio)) + 
  geom_col(position = dodge) + 
  geom_errorbar(aes(ymax = gpmeanTskRatio + (1*SE_tskR), ymin =gpmeanTskRatio -(1*SE_tskR)), position = dodge, width=.25) + 
  ylab("mean task Ratio") + 
  coord_cartesian(ylim = c(40,60)) +
  scale_fill_grey()

#### 1-way ANOVA: choice trials: tskRatio ~ 2 swProb 

z = ezANOVA(data = gpCondM3
            , dv = meanTskRatio
            , wid = sbjId
            , within = .(swProb)
            , within_full = .(swProb)
            , type = 3
            , detailed = TRUE)
z_table <- apa.ezANOVA.table(z, filename="tskRatio_2swProb.doc")
print(z_table)

```



### 4. Choice trials
#### Analyze VSR  with 3 runId_half x 2 swProb 
```{r}

gpCondM4 <- tibble()
gpCondM4 <- gpData %>% 
  filter(trialType=="choice") %>%
  filter(trialType_sw=="switch" | trialType_sw=="repeat") %>%
  group_by(sbjId, runId_half, swProb) %>%
  summarise(meanVSR = mean(trialType_int, na.rm = TRUE)) %>% ungroup() 

df <- gpCondM4
colnames(df)[colnames(df)=="meanVSR"] <- "M"
LnMSE_VSR <- getWSSE(df)

# summary for plotting later on
gp_choice2 <- gpCondM4 %>%
  group_by(runId_half, swProb) %>% 
  summarise(gpmeanVSR = mean(meanVSR)*100, SE_vsr = LnMSE_VSR*100) 

```
#### Figure 7: VSR: 3 runHalf x 2 swProb
```{r Figure7}
gp_choice2 %>%
  ggplot(aes(x=runId_half, y = gpmeanVSR, fill = swProb)) + 
  geom_col(position = dodge) + 
  geom_errorbar(aes(ymax = gpmeanVSR + (1*SE_vsr), ymin =gpmeanVSR -(1*SE_vsr)), position = dodge, width=.25) +
  ylab("mean VSR") + 
  coord_cartesian(ylim = c(30,40)) +
  scale_fill_grey()

#### 1-way ANOVA: choice trials: VSR ~ 2 swProb 
z = ezANOVA(data = gpCondM4
            , dv = meanVSR
            , wid = sbjId
            , within = .(runId_half, swProb)
            , within_full = .(runId_half, swProb)
            , type = 3
            , detailed = TRUE)
print(z)
z_table <- apa.ezANOVA.table(z, filename="VSR_3runHalfx2SwProb.doc")

```
### 5. Choice trials
#### Analyze VSR  with 6 run x 2 swProb 
```{r}

gpCondM5 <- tibble()
gpCondM5 <- gpData %>% 
  filter(trialType=="choice") %>%
  filter(trialType_sw=="switch" | trialType_sw=="repeat") %>%
  group_by(sbjId, runId, swProb) %>%
  summarise(meanVSR = mean(trialType_int, na.rm = TRUE)) %>% ungroup() 

df <- gpCondM5
colnames(df)[colnames(df)=="meanVSR"] <- "M"
LnMSE_VSR <- getWSSE(df)

# summary for plotting later on
gp_choice3 <- gpCondM5 %>%
  group_by(runId, swProb) %>% 
  summarise(gpmeanVSR = mean(meanVSR)*100, SE_vsr = LnMSE_VSR*100) 

```
#### Figure 8: VSR: 6 run x 2 swProb
```{r Figure8}
gp_choice3 %>%
  ggplot(aes(x=runId, y = gpmeanVSR, fill = swProb)) + 
  geom_col(position = dodge) + 
  geom_errorbar(aes(ymax = gpmeanVSR + (1*SE_vsr), ymin =gpmeanVSR -(1*SE_vsr)), position = dodge, width=.25) +
  ylab("mean VSR") + 
  coord_cartesian(ylim = c(30,40)) +
  scale_fill_grey()

#### 1-way ANOVA: choice trials: VSR ~ 2 swProb 
z = ezANOVA(data = gpCondM5
            , dv = meanVSR
            , wid = sbjId
            , within = .(runId, swProb)
            , within_full = .(runId, swProb)
            , type = 3
            , detailed = TRUE)
print(z)
z_table <- apa.ezANOVA.table(z, filename="VSR_6runx2SwProb.doc")

```

#### Figure 9: BFANOVA: 6 run x 2 swProb
```{r Figure9}

tt <- gpData %>% 
  filter(trialType=="choice") %>%
  filter(trialType_sw=="switch" | trialType_sw=="repeat")

data.anova.mean <- aggregate(tt$trialType_int,
                             by = list(sub    = tt$sbjId,
                                       run    = tt$runId,
                                       swProb = tt$swProb),
                             FUN = 'mean', na.rm = TRUE)

bf <- anovaBF(x ~ run * swProb + sub, data = data.anova.mean, 
             whichRandom="sub")
plot(bf)

#dd = as.data.frame(gpCondM4)
#bf <- anovaBF(meanVSR ~ run_half * swProb  + sbjId, data = dd, whichRandom="sbjId")


```
#### Figure 10: BFANOVA:2 swProb (last 4 runs only)
```{r Figure10}
tt <- gpData %>% 
  filter(trialType=="choice") %>%
  filter(runId>=5) %>%
  filter(trialType_sw=="switch" | trialType_sw=="repeat")


data.anova.mean <- aggregate(tt$trialType_int,
                             by = list(sub    = tt$sbjId,
                                       swProb = tt$swProb),
                             FUN = 'mean', na.rm = TRUE)

z = ezANOVA(data = data.anova.mean 
            , dv =x
            , wid = sub
            , within = .(swProb)
            , within_full = .(swProb)
            , type = 3
            , detailed = TRUE)
print(z)


bf <- anovaBF(x ~ swProb + sub, data = data.anova.mean, 
             whichRandom="sub")
plot(bf)

```


